<html lang="ja"> <head> <title>ドット絵エディター</title> <meta charset="UTF-8"> <style>*{margin:0;padding:0}body{background-color:#a9a9a9}input[type=number]{font-size:24px;width:96px;text-align:right}div#editframe{width:32px;height:384px;overflow:scroll;resize:both;text-align:center}div#settingsblock{background-color:#a9a9a9}div#editblock{float:left;background-color:#556b2f}div#mapchipblock{text-align:center;float:left;background-color:#483d8b}div#mapchipsblock{float:left;background-color:#8fbc8f}</style> </head> <body> <div id="settingsblock"> <input type="checkbox" id="view_index"> <label for="view_index">色番号表示</label> <input type="checkbox" id="view_grid" checked="checked"> <label for="view_grid">グリッド表示</label> <input type="color" id="grid_color" value="#00ffff"> <label for="grid_color">グリッド／番号色</label> <input type="color" id="canvas_bg_color" value="#ff00ff"> <label for="canvas_bg_color">キャンバス背景色</label> </div> <div id="editblock"> <p> 横ピクセル数<input id="editwidth" type="number" min="1"> 縦ピクセル数<input id="editheight" type="number" min="1"> 編集画面表示倍率 <select id="edit_scale"> <option value="1">x1</option> <option value="2">x2</option> <option value="4" selected="selected">x4</option> <option value="8">x8</option> <option value="16">x16</option> <option value="24">x24</option> <option value="32">x32</option> </select> </p> <p> 読み込み<input type="file" id="edit_filepath"> </p> <p> 保存形式 <select id="edit_save_format"> <option value="JSON" selected="selected">JSON</option> </select> <input type="text" id="edit_data_name" value="new_map"> <a id="download_edit_data" href="#" onClick="DownloadEditData()"><button>保存(ダウンロード)</button></a> </p> <div id="editframe"> <canvas id="edit" width="256" height="192" onContextmenu="return false;"></canvas> </div> </div> <div> <input type="radio" name="tools" id="pen_tool" value="pen_tool" checked="checked"> <label for="pen_tool">ペン</label> <input type="radio" name="tools" id="paint_tool" value="paint_tool"> <label for="paint_tool">塗りつぶし</label> </div> <div id="mapchipsblock"> <p> パレット読み込み<input type="file" accept="image/*" id="mapchip_filepath"> </p> <div id="blank_frame"> </div> <input type="color" id="palette_color" value="#000000"> <label for="palette_color">パレット色変更</label> </div> <canvas id="mapchip_bg" width="1" height="1" hidden></canvas> <script>(()=>{class t{constructor(t,e){this.w=t,this.h=e}ToIndex(t){return t*this.h+this.w}}class e{constructor(t,e,i,n){this.width=t,this.height=e,this.color_palette=i,this.tiles=n}}const i=function(e,i){const n=Math.floor(e%i),o=Math.floor(e/i);return new t(n,o)},n=function(e,i){const n=e.target.getBoundingClientRect(),o=Math.floor((e.clientX-n.left)/i),d=Math.floor((e.clientY-n.top)/i);return new t(o,d)};class o{LeftButtonDown(t){}LeftButtonUp(t){}RightButtonDown(t){}RightButtonUp(t){}MouseMove(t){}}const d=new class{constructor(){this.edit_width_=32,this.edit_height_=32,this.pixels_=JSON.parse(JSON.stringify(new Array(512).fill(new Array(512).fill(0)))),this.pixels_written_set_=new Set,this.selected_color_index_=0}get edit_scale(){return this.edit_scale_}set edit_scale(t){this.edit_scale_=t,this.is_edit_view_touched_=!0}get edit_width(){return this.edit_width_}set edit_width(t){this.edit_width_=t}get edit_height(){return this.edit_height_}set edit_height(t){this.edit_height_=t}get selected_color_index(){return this.selected_color_index_}set selected_color_index(t){this.selected_color_index_=t}get is_edit_view_touched(){return this.is_edit_view_touched_}TouchEditView(){this.is_edit_view_touched_=!0}ClearEditViewTouchedFlag(){this.is_edit_view_touched_=!1}WriteMap(t,e){this.pixels_[t.h][t.w]=e,this.pixels_written_set_.add(t.ToIndex(d.edit_width_))}GetWrittenColorIndex(t){return this.pixels_[t.h][t.w]}GetWrittenPixelSet(){return this.pixels_written_set_}MakeRawSaveData(){const t=this.edit_width_,i=this.edit_height_,n=new Array(i);for(var o=0;o<i;o++)n[o]=this.pixels_[o].slice(0,t);const d=new Array(256);for(var l=0;l<256;l++)d[l]=document.getElementById(`color_palette#${l}`).style.backgroundColor;return new e(t,i,d,n)}},l=new class extends o{LeftButtonDown(t){const e=n(t,d.edit_scale);d.WriteMap(e,d.selected_color_index)}RightButtonDown(t){const e=n(t,d.edit_scale);d.selected_color_index=d.GetWrittenColorIndex(e)}MouseMove(t){if(1===t.buttons){const e=n(t,d.edit_scale);d.WriteMap(e,d.selected_color_index)}}},r=new class extends o{LeftButtonDown(e){const o=n(e,d.edit_scale),l=d.selected_color_index,r=function(e){const i=d.edit_width,n=d.edit_height,o=new Set,l=new Array,r=d.GetWrittenColorIndex(e);o.add(e.ToIndex(i)),l.push(e);const s=function(t){d.GetWrittenColorIndex(t)==r&&(o.has(t.ToIndex(i))||(l.push(t),o.add(t.ToIndex(i))))};for(;0!=l.length;){let e=l.shift();0<e.h&&s(new t(e.w+0,e.h-1)),0<e.w&&s(new t(e.w-1,e.h+0)),e.w<i&&s(new t(e.w+1,e.h+0)),e.h<n&&s(new t(e.w+0,e.h+1))}return o}(o),s=d.edit_width;r.forEach((t=>{d.WriteMap(i(t,s),l)}))}RightButtonDown(t){const e=n(t,d.edit_scale);d.selected_color_index=d.GetWrittenColorIndex(e)}};let s=l;function c(t){return document.getElementById(t)}const a=function(t){0===t.button?s.LeftButtonDown(t):2===t.button&&s.RightButtonDown(t)},h=function(t){0===t.button?s.LeftButtonUp(t):2===t.button&&s.RightButtonUp(t)},_=function(t){s.MouseMove(t)},u=function(t){const[e,i,n]=t.split("(")[1].split(")")[0].split(",");return`#${("00"+Number(e).toString(16)).slice(-2)}${("00"+Number(i).toString(16)).slice(-2)}${("00"+Number(n).toString(16)).slice(-2)}`},g=new class{Initialize(){this.edit_canvas=c("edit"),this.blank_frame=c("blank_frame"),this.edit_frame=c("editframe"),this.palette_color=c("palette_color"),this.editwidth=c("editwidth"),this.editheight=c("editheight"),this.edit_scale=c("edit_scale"),this.edit_filepath=c("edit_filepath"),this.view_index=c("view_index"),this.view_grid=c("view_grid"),this.dom_pen_tool=c("pen_tool"),this.dom_paint_tool=c("paint_tool"),this.dom_grid_color=c("grid_color"),this.dom_canvas_bg_color=c("canvas_bg_color")}},w=function(t,e,i,n,o){t.moveTo(e,i),t.lineTo(n,o)},v=function(t,e,i,n,o,d,l,r){t.beginPath();const s=o*l,c=n*l,a=-1/d/2;for(let i of e){const e=(i+1)*l+a;w(t,e,-.5,e,s+.5)}for(let e of i){const i=(e+1)*l+a;w(t,-.5,i,c+.5,i)}t.lineWidth=1/d,t.strokeStyle=r,t.stroke()},f=function(t,e,n,o){t.save(),t.textAlign="center",t.textBaseline="middle",t.font="8px gothic",t.fillStyle=o,t.scale(1/n,1/n);const l=d.edit_width;e.forEach((e=>{const o=i(e,l),r=o.w*n,s=o.h*n,c=d.GetWrittenColorIndex(o),a=n-3*String(c).length-1;t.fillText(c.toString(),r+a,s+4)})),t.restore()},m=function(){d.is_edit_view_touched?(function(e,i,n){const o=g.edit_canvas.getContext("2d");g.edit_canvas.width=e*n,g.edit_canvas.height=i*n,o.imageSmoothingEnabled=!1,o.scale(n,n);for(var l=0;l<i;l++)for(var r=0;r<e;r++){const e=r,i=l,n=d.GetWrittenColorIndex(new t(r,l));o.fillStyle=document.getElementById(`color_palette#${n}`).style.backgroundColor,o.fillRect(e,i,1,1)}const s=g.dom_grid_color.value;g.view_index.checked&&function(e,i,n,o,d){const l=new Set;for(var r=0;r<n;r++)for(var s=0;s<i;s++)l.add(new t(s,r).ToIndex(i));f(e,l,o,d)}(o,e,i,n,s),g.view_grid.checked&&function(t,e,i,n,o,d){const l=new Set,r=new Set;for(var s=0;s<e;s++)l.add(s);for(var c=0;c<i;c++)r.add(c);v(t,l,r,e,i,n,1,d)}(o,e,i,n,0,s)}(d.edit_width,d.edit_height,d.edit_scale),d.ClearEditViewTouchedFlag()):function(t,e,n){const o=g.edit_canvas.getContext("2d"),l=d.GetWrittenPixelSet();o.scale(1,1),o.imageSmoothingEnabled=!1;const r=new Set,s=new Set;l.forEach((e=>{const n=i(e,t);r.add(n.w),s.add(n.h);const l=n.w,c=n.h,a=d.GetWrittenColorIndex(n);o.fillStyle=document.getElementById(`color_palette#${a}`).style.backgroundColor,o.fillRect(l,c,1,1)}));const c=g.dom_grid_color.value;g.view_grid.checked&&v(o,r,s,t,e,n,1,c),g.view_index.checked&&f(o,l,n,c),l.clear()}(d.edit_width,d.edit_height,d.edit_scale),g.edit_frame.style.backgroundColor=g.dom_canvas_bg_color.value,window.requestAnimationFrame(m)};!function(){g.Initialize();const e=new FileReader;!function(t,e,i){const n=document.getElementById("edit");n.width=256,n.height=192}(),function(t,e){const i=document.getElementById("editblock").clientWidth;document.getElementById("editframe").style.width=`${i}px`}(),g.edit_canvas.addEventListener("mousedown",a),g.edit_canvas.addEventListener("mouseup",h),g.edit_canvas.addEventListener("contextmenu",a),g.edit_canvas.addEventListener("mousemove",_),g.editwidth.max=512..toString(),g.editheight.max=512..toString(),g.editwidth.value=32..toString(),g.editheight.value=32..toString(),g.edit_scale.value="1",d.edit_width=g.editwidth.valueAsNumber,d.edit_height=g.editheight.valueAsNumber,d.edit_scale=Number(g.edit_scale.value),g.editwidth.addEventListener("change",(t=>{d.edit_width=t.target.valueAsNumber})),g.editheight.addEventListener("change",(t=>{d.edit_height=t.target.valueAsNumber})),g.edit_scale.addEventListener("change",(t=>{d.edit_scale=Number(t.target.value)})),g.edit_filepath.addEventListener("change",(t=>{e.readAsBinaryString(t.target.files[0])})),g.view_index.addEventListener("change",(t=>{d.TouchEditView()})),g.view_grid.addEventListener("change",(t=>{d.TouchEditView()})),g.dom_grid_color.addEventListener("input",(t=>{d.TouchEditView()})),g.palette_color.addEventListener("input",(t=>{d.TouchEditView()})),g.dom_pen_tool.addEventListener("change",(t=>{s=l})),g.dom_paint_tool.addEventListener("change",(t=>{s=r})),e.addEventListener("load",(e=>{(function(e){const i=JSON.parse(e);d.edit_width=i.width,d.edit_height=i.height,c("editwidth").value=d.edit_width.toString(),c("editheight").value=d.edit_height.toString();const n=d.edit_width,o=d.edit_height;for(var l=0;l<o;l++)for(var r=0;r<n;r++)d.WriteMap(new t(r,l),i.tiles[l][r]);for(var s=0;s<256;s++)document.getElementById(`color_palette#${s}`).style.backgroundColor=i.color_palette[s]})(e.target.result);const i=function(t){const e=t.slice(0).replace(/\\/g,"/").split("/"),i=(2<=e.length?e[e.length-1]:e[0]).split(".");return 2<=i.length?i.splice(0,i.length-1).join("."):i[0]}(c("edit_filepath").value);c("edit_data_name").value=i,d.TouchEditView()})),g.blank_frame.innerHTML=function(t,e,i){let n=`<table id="${t}">`;for(let e=0;e<16;e++){n+="<tr>";for(let i=0;i<16;i++)n+=`<td id ="${t}#${16*e+i}"><canvas width="16" height="16"></canvas></td>`;n+="<td>"}return n+="</table>",n}("color_palette");for(let t=0;t<256;t++){const e=`color_palette#${t}`,o=document.getElementById(e);o.style.backgroundColor="#000000",i=e,"click",n=()=>{d.selected_color_index=t,g.palette_color.value=u(o.style.backgroundColor)},document.getElementById(i).addEventListener("click",n)}var i,n;g.palette_color.addEventListener("input",(t=>{const e=`color_palette#${d.selected_color_index}`;document.getElementById(e).style.backgroundColor=t.target.value,d.TouchEditView()})),window.requestAnimationFrame(m)}()})();</script></body> </html>